{% comment %}
  collection-kit-feature.liquid
  Mostra il prodotto "kit" in evidenza (per handle o per tag).
  Modifica 'set-completo-marvel-funko-pop' con l'handle reale del tuo prodotto kit.
{% endcomment %}

{% schema %}
{
  "name": "Collection — Kit",
  "settings": [
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Schema colore",
      "default": "scheme-1"
    },
    {
      "type": "select",
      "id": "section_width",
      "label": "Larghezza sezione",
      "options": [
        { "value": "page-width", "label": "Pagina" },
        { "value": "full-width", "label": "Schermo intero" }
      ],
      "default": "page-width"
    },
    {
      "type": "range",
      "id": "gap",
      "label": "Spaziatura",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 12
    },
    {
      "type": "range",
      "id": "padding-block-start",
      "label": "Padding sopra",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 8
    },
    {
      "type": "range",
      "id": "padding-block-end",
      "label": "Padding sotto",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 8
    },
    {
      "type": "product",
      "id": "kit_product",
      "label": "Kit product"
    },
    {
      "type": "text",
      "id": "kit_product_handle",
      "label": "Kit product handle"
    },
    {
      "type": "checkbox",
      "id": "show_badge",
      "label": "Mostra badge 'Kit completo' ",
      "default": false
    }
  ]
}
{% endschema %}

{% comment %} Determina il prodotto kit: preferisce impostazioni di sezione, altrimenti cerca per metafield o tag nella collezione {% endcomment %}
{% assign kit_product = section.settings.kit_product %}
{% if kit_product == blank %}
  {% assign kit_handle = section.settings.kit_product_handle %}
  {% if collection %}
    {% assign found_kit = blank %}
    {% for p in collection.products %}
      {% assign is_kit = p.metafields.custom.is_kit.value %}
      {% if is_kit == blank and p.tags contains 'kit' %}
        {% assign is_kit = true %}
      {% endif %}
      {% if is_kit == true %}
        {% assign found_kit = p %}
        {% break %}
      {% endif %}
    {% endfor %}
    {% if found_kit != blank %}
      {% assign kit_product = found_kit %}
    {% elsif kit_handle != blank %}
      {% assign kit_product = all_products[kit_handle] %}
    {% endif %}
  {% elsif kit_handle != blank %}
    {% assign kit_product = all_products[kit_handle] %}
  {% endif %}
{% endif %}

{%- comment -%}
  Nascondi il kit nelle categorie che hanno collections figlie (squadre)
{%- endcomment -%}
{% assign teams_count = 0 %}
{% if collection %}
  {% for c in collections %}
    {% assign parent = c.metafields.custom.parent_category.value %}
    {% if parent != blank and parent == collection.title %}
      {% assign teams_count = teams_count | plus: 1 %}
    {% endif %}
  {% endfor %}
{% endif %}

{% unless collection and collection.handle == 'all' or teams_count > 0 %}
  {% if kit_product %}
    {% capture children %}
      <div class="kit-feature-card">
      {% if section.settings.show_badge %}
        <div class="kit-badge">Kit completo</div>
      {% endif %}
      <a href="{{ kit_product.url }}" class="kit-image-link">
        {% if kit_product.featured_image %}
          <img
            src="{{ kit_product.featured_image | img_url: '800x' }}"
            alt="{{ kit_product.title }}"
            width="{{ kit_product.featured_image.width }}"
            height="{{ kit_product.featured_image.height }}"
            loading="lazy"
          >
        {% endif %}
      </a>

        <div class="kit-info">
          <h2 class="kit-title">
            <a href="{{ kit_product.url }}">{{ kit_product.title }}</a>
          </h2>
          <div class="kit-price">
            {% if kit_product.price_varies %}
              {{ kit_product.price_min | money }} - {{ kit_product.price_max | money }}
            {% else %}
              {{ kit_product.price | money }}
            {% endif %}
          </div>
          <div class="kit-excerpt">
            {{ kit_product.description | strip_html | truncate: 160 }}
          </div>
          <a href="{{ kit_product.url }}" class="button">Vedi il kit</a>
        </div>
      </div>
    {% endcapture %}
    {% render 'section', section: section, children: children %}
  {% else %}
    <!-- fallback se non trova il prodotto -->
    <p class="kit-feature-empty">
      Il prodotto kit non è stato trovato. Controlla l'handle nelle impostazioni della sezione.
    </p>
  {% endif %}
{% endunless %}

<style>
  /* Semplice CSS di base — adattalo al design Horizon del tuo store */
  .kit-feature-card { display:flex; gap:1.25rem; align-items:center; margin-inline: auto; max-width: min(100%, 1000px); }
  .kit-image-link img { width: 220px; height: auto; border-radius: 10px; object-fit: cover; }
  .kit-title { margin:0 0 .5rem; font-size:1.25rem; }
  .kit-badge { background: rgb(var(--color-foreground-rgb) / var(--opacity-20)); color: var(--color-foreground); padding:.25rem .5rem; display:inline-block; border-radius:6px; font-size:.8rem; margin-bottom:.5rem; }
  .kit-info .button { margin-top:.75rem; display:inline-block; padding:.5rem .75rem; border-radius:8px; text-decoration:none; color: var(--color-primary-button-text); background-color: var(--color-primary-button-background); border: 1px solid var(--color-primary-button-border); }
  @media (max-width: 720px) {
    .kit-feature-card { flex-direction: column; text-align:center; }
    .kit-image-link img { width:100%; max-width:300px; }
  }
</style>
